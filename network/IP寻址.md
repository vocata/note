# IP寻址

主机在接入一个子网时，会根据DHCP协议自动获取分配一个IP地址，并且会子网的网络配置，包括

- 网关地址：出入子网的第一跳路由
- DNS服务器IP地址
- 子网掩码，用于指示网络地址

其中子网掩码用于检测目标地址是否与主机地址同处于一个网络，而网关地址决定了当目标地址不在网络内部时的默认寻址出口（第一跳路由）

寻址过程：

1. 主机A与主机B处于同一个网络：主机A向主机B发送数据，主机A会先将自己的IP地址与主机B的IP地址与子网掩码做与运算，如果得到的网络地址相同，则表示主机B与主机A处于同一网络。此时主机A会走ARP协议向子网中广播主机B的IP地址，请求后去主机主机B的MAC地址，主机B在收到ARP数据后，会检测目标IP地址是否和自身IP地址相匹配，若匹配则返回自身的MAC地址，主机A收到主机B的MAC地址后，就通过链路层协议向该地址发送数据。
2. 主机A与主机B不处于同一网络：同样进行掩码操作，得到网络地址不相同，此时主机A会尝试获取默认网关的MAC地址，也是通过ARP协议广播默认网关的IP地址，不过一般情况下主机A都会再ARP表里保存网关IP地址到MAC地址的映射，无需再走ARP协议。

> 假设主机A和主机B都连接在同一个网关下，理论上他们的网络地址应该都一样，但也存在人为的去更改主机B的子网掩码，导致主机A和主机B的网络地址不一致。例如主机A的IP地址为192.168.0.1，子网掩码为255.255.0.0；主机B的IP地址为192.168.1.1，子网掩码为255.255.255.0。此时主机A的网络地址为192.168.0.0，而主机B的网络地址为192.168.1.0，如果主机A向主机B发送数据，如上所述，会将主机A和主机B的IP与主机A的子网掩码进行，得到相同的网络地址192.168.0.0，因此可以正确获取到主机B的MAC地址并正常向主机B发送数据。但是相反，主机B向主机A发送数据，掩码操作后得到的网络地址分别是192.168.1.0和192.168.0.0，不在同一网段，因此会获取网关的MAC地址并向网关发送请求，请求无法到达主机A。
