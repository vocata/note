# 使用apply patch的规则

> prerequisite
> 
> 使用apply应用配置时，会在metadata中新增一个注解：last-applied-configuration，这个注解的内容始终和最新apply的配置的文件保持一致，用于使用apply进行patch时计算删除的字段。注意这个注解不一定和运行中的配置（现时配置）一致，因为其他kubectl的命令例如patch，scale都可以增加字段。

## 合并补丁计算

使用kubectl apply应用新的配置时，会根据一定规则计算出需要删除/新增/修改的字段，步骤如下：

1. 计算需要删除的字段：对比注解last-applied-configuration与新配置的差异，计算注解中存在但在新配置总不存在的字段，执行删除操作。由于通过kubectl scale等命令新增的字段不会出现在注解中，所以这部分字段不会被删除。
2. 计算更新/添加的字段：对比现时配置和新配置的差异，在现时配置中不存在但是在新配置中存在的字段，执行新增操作；在现时配置中存在但值与新配置中不通的字段，执行更新操作。由于是和现时配置进行比较，所以通过其他命令新增的字段也会纳入考虑。
